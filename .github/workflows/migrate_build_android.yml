name: Migrate to Android 14 & Build APK

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch: # Permite rodar manualmente se precisar

# Permissões necessárias para o script fazer o commit e push de volta no repo
permissions:
  contents: write

jobs:
  migrate-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      # ---------------------------------------------------------
      # ETAPA 1: CRIAÇÃO DA ESTRUTURA ANDROID (MIGRAÇÃO)
      # ---------------------------------------------------------
      - name: Migrate Project Structure to Android Gradle
        run: |
          # Verifica se já foi migrado para evitar rodar duas vezes
          if [ -f "app/build.gradle.kts" ]; then
            echo "Project already appears to be Android structure. Skipping migration."
            exit 0
          fi

          echo "Starting Migration to Android Structure..."

          # 1. Criar diretórios padrão Android
          mkdir -p app/src/main/java
          mkdir -p app/src/main/res/values
          mkdir -p gradle/wrapper

          # 2. Mover código fonte Kotlin atual para a pasta Android
          # Se a pasta src/main/kotlin existir, move o conteúdo
          if [ -d "src/main/kotlin" ]; then
            cp -r src/main/kotlin/* app/src/main/java/
            rm -rf src
            echo "Source code moved."
          else
            echo "Warning: src/main/kotlin not found, creating empty structure."
          fi
          
          # Mover resources se existirem
          if [ -d "src/main/resources" ]; then
             mkdir -p app/src/main/resources
             cp -r src/main/resources/* app/src/main/resources/
          fi

          # 3. Criar settings.gradle.kts
          cat <<EOF > settings.gradle.kts
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "SNES-Emulator"
          include(":app")
          EOF

          # 4. Criar build.gradle.kts (Raiz)
          cat <<EOF > build.gradle.kts
          plugins {
              id("com.android.application") version "8.2.0" apply false
              id("org.jetbrains.kotlin.android") version "1.9.20" apply false
          }
          EOF

          # 5. Criar app/build.gradle.kts (App - API 34 / Android 14)
          cat <<EOF > app/build.gradle.kts
          plugins {
              id("com.android.application")
              id("org.jetbrains.kotlin.android")
          }

          android {
              namespace = "de.dde.snes"
              compileSdk = 34

              defaultConfig {
                  applicationId = "de.dde.snes"
                  minSdk = 26
                  targetSdk = 34
                  versionCode = 1
                  versionName = "1.0"
                  testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
              }

              buildTypes {
                  release {
                      isMinifyEnabled = false
                      proguardFiles(getDefaultProguardFile("proguard-android-optimize.txt"), "proguard-rules.pro")
                  }
              }
              compileOptions {
                  sourceCompatibility = JavaVersion.VERSION_1_8
                  targetCompatibility = JavaVersion.VERSION_1_8
              }
              kotlinOptions {
                  jvmTarget = "1.8"
              }
              
              // Permite acesso a recursos não-Android na pasta resources (para compatibilidade com seu código atual)
              sourceSets {
                  getByName("main") {
                      resources.srcDirs("src/main/resources")
                  }
              }
          }

          dependencies {
              implementation("androidx.core:core-ktx:1.12.0")
              implementation("androidx.appcompat:appcompat:1.6.1")
              implementation("com.google.android.material:material:1.11.0")
              testImplementation("junit:junit:4.13.2")
              androidTestImplementation("androidx.test.ext:junit:1.1.5")
              androidTestImplementation("androidx.test.espresso:espresso-core:3.5.1")
              // Adiciona dependência padrão do Kotlin
              implementation(platform("org.jetbrains.kotlin:kotlin-bom:1.8.0"))
          }
          EOF

          # 6. Criar AndroidManifest.xml
          cat <<EOF > app/src/main/AndroidManifest.xml
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <application
                  android:allowBackup="true"
                  android:icon="@mipmap/ic_launcher"
                  android:label="SNES Emulator"
                  android:roundIcon="@mipmap/ic_launcher_round"
                  android:supportsRtl="true"
                  android:theme="@style/Theme.AppCompat.Light.NoActionBar">
                  
                  <!-- Atividade principal fictícia para permitir o build, 
                       já que seu código original não tem Activity -->
                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF
          
          # 7. Criar uma MainActivity básica (Stub) para o Android reconhecer o app
          # Isso é necessário pois seu código original só tem fun main()
          mkdir -p app/src/main/java/de/dde/snes
          cat <<EOF > app/src/main/java/de/dde/snes/MainActivity.kt
          package de.dde.snes

          import android.os.Bundle
          import androidx.appcompat.app.AppCompatActivity
          import android.widget.TextView

          class MainActivity : AppCompatActivity() {
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  val textView = TextView(this)
                  textView.text = "SNES Emulator Core Loaded"
                  setContentView(textView)
                  
                  // AQUI: Futuramente você deve chamar seu código snes.start()
                  // numa Thread separada
              }
          }
          EOF

          # 8. Limpar arquivos do IntelliJ antigos que não são usados no Android Gradle
          rm -rf .idea
          rm -f *.iml
          rm -f .gitignore
          
          # Criar .gitignore novo
          cat <<EOF > .gitignore
          *.iml
          .gradle
          /local.properties
          /.idea/caches
          /.idea/libraries
          /.idea/modules.xml
          /.idea/workspace.xml
          /.idea/navEditor.xml
          /.idea/assetWizardSettings.xml
          .DS_Store
          /build
          /captures
          .externalNativeBuild
          .cxx
          local.properties
          EOF

      # ---------------------------------------------------------
      # ETAPA 2: GERAR WRAPPER GRADLE
      # ---------------------------------------------------------
      - name: Setup Gradle Wrapper
        run: gradle wrapper --gradle-version 8.4

      # ---------------------------------------------------------
      # ETAPA 3: COMMIT & PUSH DAS MUDANÇAS
      # ---------------------------------------------------------
      - name: Commit and Push Migration
        run: |
          git add .
          # Verifica se há algo para comitar
          if git diff-index --quiet HEAD --; then
             echo "No changes to commit"
          else
             git commit -m "Auto-migration to Android 14 Project Structure [skip ci]"
             git push
          fi

      # ---------------------------------------------------------
      # ETAPA 4: BUILD DO APK
      # ---------------------------------------------------------
      - name: Build APK
        run: ./gradlew assembleDebug --stacktrace

      # ---------------------------------------------------------
      # ETAPA 5: UPLOAD DO APK GERADO
      # ---------------------------------------------------------
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: snes-emulator-android-14
          path: app/build/outputs/apk/debug/app-debug.apk
