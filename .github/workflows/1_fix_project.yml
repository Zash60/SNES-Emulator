name: Fix Missing Resources & Properties

on:
  workflow_dispatch: # Rode manualmente

permissions:
  contents: write

jobs:
  fix-resources:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      # ------------------------------------------------------------------
      # 1. CRIAR GRADLE.PROPERTIES (Corrige erro de AndroidX)
      # ------------------------------------------------------------------
      - name: Create gradle.properties
        run: |
          echo ">>> Criando gradle.properties..."
          cat <<EOF > gradle.properties
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
          EOF

      # ------------------------------------------------------------------
      # 2. CRIAR ÍCONES FALTANTES (Corrige erro AAPT/Linking)
      # ------------------------------------------------------------------
      - name: Create Dummy Icons (XML Vectors)
        run: |
          echo ">>> Criando diretórios de recursos..."
          mkdir -p app/src/main/res/mipmap-hdpi
          mkdir -p app/src/main/res/values

          echo ">>> Criando ícone 'ic_launcher.xml'..."
          # Criamos um ícone vetorial simples (quadrado verde) para servir de placeholder
          # Isso satisfaz o compilador sem precisar fazer upload de binários PNG
          cat <<EOF > app/src/main/res/mipmap-hdpi/ic_launcher.xml
          <vector xmlns:android="http://schemas.android.com/apk/res/android"
              android:width="108dp"
              android:height="108dp"
              android:viewportWidth="108"
              android:viewportHeight="108">
              <path android:fillColor="#008577" android:pathData="M0,0h108v108h-108z"/>
              <path android:fillColor="#FFFFFF" android:pathData="M54,54m-20,0a20,20 0 1,1 40,0a20,20 0 1,1 -40,0"/>
          </vector>
          EOF

          echo ">>> Criando ícone 'ic_launcher_round.xml'..."
          cp app/src/main/res/mipmap-hdpi/ic_launcher.xml app/src/main/res/mipmap-hdpi/ic_launcher_round.xml

      # ------------------------------------------------------------------
      # 3. CRIAR ARQUIVOS DE VALORES BÁSICOS (Prevenção)
      # ------------------------------------------------------------------
      - name: Create Basic Strings/Colors
        run: |
          # Garante que colors.xml existe para não dar erro se o tema referenciar
          if [ ! -f "app/src/main/res/values/colors.xml" ]; then
            cat <<EOF > app/src/main/res/values/colors.xml
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <color name="colorPrimary">#008577</color>
              <color name="colorPrimaryDark">#00574B</color>
              <color name="colorAccent">#D81B60</color>
          </resources>
          EOF
          fi
          
          # Garante que strings.xml existe
          if [ ! -f "app/src/main/res/values/strings.xml" ]; then
            cat <<EOF > app/src/main/res/values/strings.xml
          <resources>
              <string name="app_name">SNES Emulator</string>
          </resources>
          EOF
          fi

      # ------------------------------------------------------------------
      # 4. COMMIT E PUSH
      # ------------------------------------------------------------------
      - name: Commit Resource Fixes
        run: |
          git add gradle.properties app/src/main/res
          
          if git diff-index --quiet HEAD --; then
             echo "Tudo já estava correto."
          else
             git commit -m "Fix: Create missing icons and gradle.properties"
             git push
          fi
