name: Fix PPU Syntax (YAML Safe Mode)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fix-ppu-renderer:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      # ------------------------------------------------------------------
      # 1. LIMPEZA (REMOVER CÓDIGO QUEBRADO ANTERIOR)
      # ------------------------------------------------------------------
      - name: Clean Bad Injection
        run: |
          FILE="app/src/main/java/de/dde/snes/ppu/PPU.kt"
          
          if [ -f "$FILE" ]; then
             echo ">>> Limpando injeções quebradas..."
             
             # Remove a chamada que estava solta
             sed -i '/renderScanline(voffset)/d' "$FILE"
             
             # Remove blocos de tentativas anteriores (limpa do comentário até o fim, ou linhas específicas)
             sed -i '/\/\/ --- DEBUG RENDERER/d' "$FILE"
             sed -i '/private fun getIntColor/d' "$FILE"
             sed -i '/private fun renderScanline/d' "$FILE"
             
             # Assegura que o arquivo termina corretamente (caso a chave } tenha sumido)
             # Mas cuidado para não duplicar. Vamos confiar que o sed acima limpou o miolo.
             
             echo "Arquivo limpo."
          fi

      # ------------------------------------------------------------------
      # 2. INJETAR USANDO PRINTF (EVITA ERRO DE DOIS PONTOS NO YAML)
      # ------------------------------------------------------------------
      - name: Inject Renderer Safely
        run: |
          FILE="app/src/main/java/de/dde/snes/ppu/PPU.kt"
          
          if [ -f "$FILE" ]; then
             echo ">>> Injetando renderizador de forma segura..."

             # 1. Inserir a chamada (Call site)
             sed -i '/if (hoffset == FIRST_H_OFFSET + snes.version.width) {/a \                renderScanline(voffset)' "$FILE"

             # 2. Preparar o código Kotlin usando PRINTF (Isso protege os dois pontos ':')
             # Criamos o arquivo renderer.txt com o código
             
             printf "\n" > renderer.txt
             printf "    // --- DEBUG RENDERER ---\n" >> renderer.txt
             printf "    private fun getIntColor(c: Int): Int {\n" >> renderer.txt
             printf "        val r = (c and 0x1F) shl 3\n" >> renderer.txt
             printf "        val g = ((c shr 5) and 0x1F) shl 3\n" >> renderer.txt
             printf "        val b = ((c shr 10) and 0x1F) shl 3\n" >> renderer.txt
             printf "        return (0xFF shl 24) or (r shl 16) or (g shl 8) or b\n" >> renderer.txt
             printf "    }\n\n" >> renderer.txt
             
             printf "    private fun renderScanline(y: Int) {\n" >> renderer.txt
             printf "        if (y < 0 || y >= 224) return\n" >> renderer.txt
             printf "        try {\n" >> renderer.txt
             printf "            val bgColor = getIntColor(cgram.colors[0].value)\n" >> renderer.txt
             printf "            for (x in 0 until 256) {\n" >> renderer.txt
             printf "                val index = y * 256 + x\n" >> renderer.txt
             printf "                if (index < videoBuffer.size) {\n" >> renderer.txt
             printf "                    val vramIndex = index %% vram.vram.size\n" >> renderer.txt
             printf "                    val pixelData = vram.vram[vramIndex].toInt()\n" >> renderer.txt
             printf "                    if (pixelData != 0) {\n" >> renderer.txt
             printf "                        videoBuffer[index] = bgColor or 0x00505050\n" >> renderer.txt
             printf "                    } else {\n" >> renderer.txt
             printf "                        videoBuffer[index] = bgColor\n" >> renderer.txt
             printf "                    }\n" >> renderer.txt
             printf "                }\n" >> renderer.txt
             printf "            }\n" >> renderer.txt
             printf "        } catch (e: Exception) {}\n" >> renderer.txt
             printf "    }\n" >> renderer.txt
             
             # 3. Inserir o conteúdo de renderer.txt ANTES da linha "companion object"
             # Isso garante que fique dentro da classe PPU
             sed -i '/companion object {/e cat renderer.txt' "$FILE"
             
             rm renderer.txt
             echo "Código injetado com sucesso."
          else
             echo "ERRO: PPU.kt não encontrado."
             exit 1
          fi

      # ------------------------------------------------------------------
      # 3. COMMIT
      # ------------------------------------------------------------------
      - name: Commit Fix
        run: |
          git add .
          if git diff-index --quiet HEAD --; then
             echo "Nada mudou."
          else
             git commit -m "Fix: Inject PPU code using printf to avoid YAML syntax errors"
             git push
          fi
