name: Activate VRAM Viewer (Safe Mode)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  switch-renderer:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Replace Rainbow with VRAM Viewer
        run: |
          FILE="app/src/main/java/de/dde/snes/ppu/PPU.kt"
          
          if [ -f "$FILE" ]; then
             echo ">>> Substituindo renderizador..."

             # 1. DELETAR O RENDERIZADOR ARCO-ÍRIS ANTIGO
             # Deleta da linha 'private fun renderScanline' até a linha que contém 'override fun readByte'
             # Mantendo a linha do override (usando o comando 'd' apenas se não for o match final)
             # Isso limpa a função antiga completamente.
             sed -i '/private fun renderScanline/,/override fun readByte/ { /override fun readByte/!d; }' "$FILE"
             
             # 2. CRIAR O NOVO CÓDIGO (VRAM VIEWER) USANDO PRINTF
             # O uso de printf evita erros de sintaxe YAML (: ou identação)
             
             printf "\n" > vram_code.kt
             printf "    // --- VRAM DEBUG VIEWER ---\n" >> vram_code.kt
             printf "    private fun renderScanline(y: Int) {\n" >> vram_code.kt
             printf "        if (y < 0 || y >= 224) return\n" >> vram_code.kt
             printf "        // Cor de fundo fixa (Preto)\n" >> vram_code.kt
             printf "        val bgColor = 0xFF000000.toInt()\n" >> vram_code.kt
             printf "        for (x in 0 until 256) {\n" >> vram_code.kt
             printf "            val index = y * 256 + x\n" >> vram_code.kt
             printf "            if (index < videoBuffer.size) {\n" >> vram_code.kt
             printf "                // Mapeia pixel da tela -> byte da VRAM\n" >> vram_code.kt
             printf "                val vramIndex = index %% vram.vram.size\n" >> vram_code.kt
             printf "                val pixelData = vram.vram[vramIndex].toInt()\n" >> vram_code.kt
             printf "                if (pixelData != 0) {\n" >> vram_code.kt
             printf "                    // Se tem dados, pinta de branco (mostra graficos)\n" >> vram_code.kt
             printf "                    videoBuffer[index] = 0xFFFFFFFF.toInt()\n" >> vram_code.kt
             printf "                } else {\n" >> vram_code.kt
             printf "                    videoBuffer[index] = bgColor\n" >> vram_code.kt
             printf "                }\n" >> vram_code.kt
             printf "            }\n" >> vram_code.kt
             printf "        }\n" >> vram_code.kt
             printf "    }\n\n" >> vram_code.kt
             
             # 3. INJETAR O NOVO CÓDIGO
             # Insere o conteúdo do arquivo vram_code.kt imediatamente ANTES da linha "override fun readByte"
             sed -i '/override fun readByte/e cat vram_code.kt' "$FILE"
             
             rm vram_code.kt
             echo "Visualizador de VRAM ativado."
          else
             echo "ERRO: PPU.kt não encontrado."
             exit 1
          fi

      - name: Commit VRAM Feature
        run: |
          git add .
          if git diff-index --quiet HEAD --; then
             echo "Nada mudou."
          else
             git commit -m "Feat: VRAM Debug Viewer (Safe Injection)"
             git push
          fi
