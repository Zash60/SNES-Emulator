name: Fix Runtime Crash & Warnings

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fix-runtime:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      # ------------------------------------------------------------------
      # 1. CORRIGIR O CRASH (IllegalStateException: invalid Read-Access)
      # ------------------------------------------------------------------
      - name: Enable Invalid Access (Open Bus)
        run: |
          echo ">>> Corrigindo MemoryImpl.kt para permitir leituras inválidas (Open Bus)..."
          
          FILE="app/src/main/java/de/dde/snes/memory/MemoryImpl.kt"
          
          if [ -f "$FILE" ]; then
             # O erro ocorre porque o HardwareMapping é instanciado com 'false' (não permitir acesso inválido).
             # Mudamos para 'true' para simular o hardware real (retornar último valor do barramento em vez de crashar).
             
             # Procura: val hardwareMapping = HardwareMapping(snes, false)
             # Substitui por: val hardwareMapping = HardwareMapping(snes, true)
             sed -i 's/HardwareMapping(snes, false)/HardwareMapping(snes, true)/g' "$FILE"
             
             echo "Correção aplicada em MemoryImpl.kt"
          else
             echo "ERRO: Arquivo MemoryImpl.kt não encontrado!"
             exit 1
          fi

      # ------------------------------------------------------------------
      # 2. LIMPAR OS WARNINGS (Parameter 'bank' is never used)
      # ------------------------------------------------------------------
      - name: Suppress Kotlin Warnings
        run: |
          echo ">>> Adicionando supressão de avisos nos arquivos..."

          # Função para adicionar @Suppress no topo do arquivo se não existir
          add_suppress() {
              local file=$1
              if [ -f "$file" ]; then
                  # Verifica se já tem a supressão
                  if ! grep -q "@file:Suppress" "$file"; then
                      # Lê o conteúdo
                      local content=$(cat "$file")
                      # Reescreve com a supressão no topo
                      echo "@file:Suppress(\"UNUSED_PARAMETER\")" > "$file"
                      echo "" >> "$file"
                      echo "$content" >> "$file"
                      echo "Warnings suprimidos em $(basename $file)"
                  fi
              fi
          }

          # Aplica em HardwareMapping.kt (Onde tem vários avisos de 'bank')
          add_suppress "app/src/main/java/de/dde/snes/memory/HardwareMapping.kt"

          # Aplica em PPU.kt (Aviso de 'cycles')
          add_suppress "app/src/main/java/de/dde/snes/ppu/PPU.kt"
          
          # Aplica em Processor2.kt (Vários avisos de 'value')
          add_suppress "app/src/main/java/de/dde/snes/processor/Processor2.kt"

      # ------------------------------------------------------------------
      # 3. COMMIT E PUSH
      # ------------------------------------------------------------------
      - name: Commit Fixes
        run: |
          git add .
          if git diff-index --quiet HEAD --; then
             echo "Nenhuma mudança necessária."
          else
             git commit -m "Fix: Enable HardwareMapping loose access to prevent crash & suppress warnings"
             git push
          fi
