name: Fix PPU Syntax Error

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fix-ppu:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      # ------------------------------------------------------------------
      # CORRIGIR O ARQUIVO PPU.KT
      # ------------------------------------------------------------------
      - name: Repair PPU.kt Structure
        run: |
          FILE="app/src/main/java/de/dde/snes/ppu/PPU.kt"
          
          if [ -f "$FILE" ]; then
             echo ">>> Reparando PPU.kt..."
             
             # 1. Remover as linhas inseridas no lugar errado (dentro do construtor)
             # Isso limpa a sujeira do script anterior
             sed -i '/var frameReady = false/d' "$FILE"
             sed -i '/val videoBuffer =/d' "$FILE"
             
             # 2. Inserir as variáveis no lugar CORRETO (Dentro do corpo da classe)
             # Usamos 'val oam = OAM()' como âncora, pois sabemos que esta linha está dentro das chaves { }
             # O comando 'i' insere ANTES dessa linha
             sed -i '/val oam = OAM()/i \    var frameReady = false\n    val videoBuffer = IntArray(256 * 240) \/\/ Buffer de Video' "$FILE"
             
             echo "PPU.kt corrigido com sucesso."
          else
             echo "ERRO: PPU.kt não encontrado."
             exit 1
          fi

      # ------------------------------------------------------------------
      # COMMIT E PUSH
      # ------------------------------------------------------------------
      - name: Commit Fix
        run: |
          git add .
          if git diff-index --quiet HEAD --; then
             echo "Nenhuma mudança necessária."
          else
             git commit -m "Fix: Move PPU properties out of constructor"
             git push
          fi
