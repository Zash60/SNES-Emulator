name: Fix Compilation Error (Reserved Names)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fix-reserved-names:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      # ------------------------------------------------------------------
      # REVERTER NOMES DE VARIÁVEIS (_ -> nome original)
      # ------------------------------------------------------------------
      - name: Revert Variable Names
        run: |
          echo "Corrigindo erro de nomes reservados..."
          
          # 1. HardwareMapping.kt: Reverter "_: Bank" para "bank: Bank"
          HW_FILE="app/src/main/java/de/dde/snes/memory/HardwareMapping.kt"
          if [ -f "$HW_FILE" ]; then
             # O comando anterior quebrou o código ao mudar para _. Voltamos para 'bank'.
             sed -i 's/_: Bank/bank: Bank/g' "$HW_FILE"
             echo "HardwareMapping.kt corrigido."
          fi

          # 2. PPU.kt: Reverter "_: Long" para "cycles: Long"
          PPU_FILE="app/src/main/java/de/dde/snes/ppu/PPU.kt"
          if [ -f "$PPU_FILE" ]; then
             # Voltamos para 'cycles'
             sed -i 's/_: Long/cycles: Long/g' "$PPU_FILE"
             echo "PPU.kt corrigido."
          fi

      # ------------------------------------------------------------------
      # COMMIT E PUSH
      # ------------------------------------------------------------------
      - name: Commit Fix
        run: |
          git add .
          if git diff-index --quiet HEAD --; then
             echo "Nenhuma correção necessária (arquivos já estavam certos)."
          else
             git commit -m "Fix: Revert reserved parameter names to fix compilation"
             git push
          fi
