name: Force Video Test (YAML Safe)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  inject-test-pattern:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      # ------------------------------------------------------------------
      # INJETAR PADRÃO DE TESTE ARCO-ÍRIS (MÉTODO BLINDADO)
      # ------------------------------------------------------------------
      - name: Inject Rainbow Pattern using Printf
        run: |
          FILE="app/src/main/java/de/dde/snes/ppu/PPU.kt"
          
          if [ -f "$FILE" ]; then
             echo ">>> Substituindo renderizador por Padrão de Teste..."

             # 1. Limpar funções de renderização antigas para evitar duplicidade
             # Removemos qualquer função renderScanline ou getIntColor existente
             sed -i '/private fun renderScanline/,/}/d' "$FILE"
             sed -i '/private fun getIntColor/,/}/d' "$FILE"
             
             # 2. Criar o código do Padrão de Teste usando PRINTF
             # O uso de printf evita que o YAML interprete os dois pontos (:) como erro
             
             printf "\n" > test_code.kt
             printf "    // --- MODO DE TESTE (RAINBOW) ---\n" >> test_code.kt
             # Note: y: Int está entre aspas, o YAML não vai reclamar
             printf "    private fun renderScanline(y: Int) {\n" >> test_code.kt
             printf "        if (y < 0 || y >= 224) return\n" >> test_code.kt
             printf "        for (x in 0 until 256) {\n" >> test_code.kt
             printf "            val index = y * 256 + x\n" >> test_code.kt
             printf "            if (index < videoBuffer.size) {\n" >> test_code.kt
             printf "                val r = (x * 1) %% 255\n" >> test_code.kt
             printf "                val g = (y * 1) %% 255\n" >> test_code.kt
             printf "                val b = (x + y) %% 255\n" >> test_code.kt
             printf "                val color = (0xFF shl 24) or (r shl 16) or (g shl 8) or b\n" >> test_code.kt
             printf "                videoBuffer[index] = color\n" >> test_code.kt
             printf "            }\n" >> test_code.kt
             printf "        }\n" >> test_code.kt
             printf "    }\n" >> test_code.kt
             
             # 3. Inserir o código dentro da classe PPU
             # Usamos 'companion object' como âncora, inserindo antes dele
             sed -i '/companion object {/e cat test_code.kt' "$FILE"
             
             rm test_code.kt
             echo "Código injetado com sucesso."
          else
             echo "ERRO: PPU.kt não encontrado."
             exit 1
          fi

      # ------------------------------------------------------------------
      # COMMIT E PUSH
      # ------------------------------------------------------------------
      - name: Commit Test Pattern
        run: |
          git add .
          if git diff-index --quiet HEAD --; then
             echo "Nada mudou."
          else
             git commit -m "Debug: Inject Rainbow Test Pattern (Safe Mode)"
             git push
          fi
